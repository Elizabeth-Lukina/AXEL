import sqlite3
from datetime import date
import logging
from config import TELEGRAM_TOKEN, OWM_API_KEY
import telebot
from apscheduler.schedulers.background import BackgroundScheduler
import pytz

from quote import get_quote
from weather import get_weather
from currency import get_currency
from database import init_db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
init_db()

# –°–æ–∑–¥–∞–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –±–æ—Ç–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
bot = telebot.TeleBot(TELEGRAM_TOKEN)
scheduler = BackgroundScheduler(timezone=pytz.timezone("Europe/Moscow"))
scheduler.start()

DB_PATH = "weatherbot.db"

def connect():
    return sqlite3.connect(DB_PATH)

def get_tasks(chat_id):
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT task FROM tasks WHERE chat_id=? AND due_date=?", (chat_id, date.today()))
        rows = cur.fetchall()

    if not rows:
        return "‚úÖ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–¥–∞—á –Ω–µ—Ç."
    return "üìã –ó–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n" + "\n".join(f"‚Äî {row[0]}" for row in rows)

def send_report(chat_id, city):
    try:
        parts = [
            get_weather(city),
            get_currency(),
            get_tasks(chat_id),
            get_quote()
        ]
        message = "\n\n".join(filter(None, parts))  # –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —á–∞—Å—Ç–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        bot.send_message(chat_id, message)
        logger.info(f"[DEBUG] –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏ –¥–ª—è {chat_id}")
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ {chat_id}: {e}")

def schedule_reports():
    with connect() as conn:
        cur = conn.cursor()
        cur.execute("SELECT chat_id, city, send_hour, send_minute FROM users WHERE daily_enabled=1")
        users = cur.fetchall()

    for chat_id, city, hour, minute in users:
        try:
            scheduler.add_job(
                send_report,
                trigger="cron",
                hour=hour,
                minute=minute,
                args=[chat_id, city],
                id=f"report_{chat_id}",
                replace_existing=True
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –¥–ª—è {chat_id}: {e}")

